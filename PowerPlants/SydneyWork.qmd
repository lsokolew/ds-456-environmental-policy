---
title: "FP2 Revisited"
format: html
editor: visual
---

AI Statement: I used ChatGPT to help me with the zcta files since I have never used them before, and my code was nor running correctly

SETUP

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(leaflet)
library(dplyr)
library(tidycensus)
library(tigris)
library(naniar)
library(tidyverse)
library(sf)
library(htmlwidgets)
library(htmltools)
library(httr)
library(jsonlite)

```

DATA

```{r, include=FALSE }

# Power plants
american_powerPlants <- read_csv("Power_Plants.csv")
mn_powerplants <- american_powerPlants %>%
  filter(State == "Minnesota") %>% 
  mutate(energy_source = ifelse(PrimSource %in% c("coal", "petroleum", "natural gas"), "Fossil Fuel", "Renewable"))

# Operating Years
powerplant_dates <- read_csv("powerplant_data_eia_egrid_2024_generator_operable.csv") %>% 
  janitor::clean_names() 
powerplant_dates_mn <- powerplant_dates %>% 
  filter(state == "MN") %>% 
  mutate(full_date = make_date(year = operating_year, month = operating_month, day = 1)) %>% 
  group_by(plant_code) %>% 
  summarise(first_op_date = min(full_date))

# add years to mn_powerplants (main dataset we're using for powerplants)
mn_powerplants <- mn_powerplants %>% left_join(powerplant_dates_mn, by = c("Plant_Code" = "plant_code"))

# fill in missing dates:
# Buffalo Sun CSG - active since 2/1/2025
# Oster Sun CSG	- active since 1/1/2025
# Quarry Sun CSG - active since 1/1/2025
# via sunshare website
mn_powerplants <- mn_powerplants %>%
  mutate(first_op_date = case_when(Plant_Code == 66070 ~ as.Date(mdy("2/1/2025")),
                                   Plant_Code == 66072 ~ as.Date(mdy("1/1/2025")),
                                   Plant_Code == 66073 ~ as.Date(mdy("1/1/2025")),
                                   TRUE ~ first_op_date), 
         first_op_year = year(first_op_date)
         ) 
mn_powerplants



# Health
copd <- read_csv("copd.csv")
asthmaMN <- read_csv("MN-asthma-zipcode.csv") 
# Air
air <- read_csv("air.csv")



# Filter for specific zip codes if needed
# For example, to get data for zip codes 90210 and 90001

zctas <- zctas(cb = FALSE, year = 2020)
mn_counties <- counties(state = "MN", class = "sf")
mn_zctas <- st_filter(zctas, mn_counties)


zcta_joined <- asthmaMN %>%
  left_join(mn_zctas, by = c("_ZIP" = "GEOID20")) %>%
  mutate(`Age-adjusted rate per 10,000` = na_if(`Age-adjusted rate per 10,000`, "*"),
        `Age-adjusted rate per 10,000` = as.numeric(`Age-adjusted rate per 10,000`)) %>%
   mutate(value_cat = case_when(
    `Age-adjusted rate per 10,000` >= 0 & `Age-adjusted rate per 10,000` <= 2 ~ "0-2",
    `Age-adjusted rate per 10,000` >= 2 & `Age-adjusted rate per 10,000` <= 4 ~ "2-4",
    `Age-adjusted rate per 10,000` >= 4 & `Age-adjusted rate per 10,000` <= 7 ~ "4-7",
    `Age-adjusted rate per 10,000` >= 7 ~ "7+"))

zcta_joined <- st_as_sf(zcta_joined)


```

AIR

```{r}
air %>%
  group_by(year) %>%
  summarize(avg_air = mean(pm25AvgMod)) %>%
  ggplot(aes(x = year, y = avg_air)) +
  geom_point() + theme_classic()
```

COPD

```{r}
copd_total_hospitalizations <- copd %>%
  group_by(year) %>%
  summarise(hospitalizations = sum(count)) %>%
  slice(3:23) %>%
  mutate(year = as.numeric(year))

copd_total_hospitalizations %>%
  ggplot(aes(x = year, y = hospitalizations)) + 
  geom_point() +
  theme_classic() + 
  labs(title = "COPD Hospitalizations between 2000-2020 in MN", x = "Year", y = "Hospitalizations")
  
```

ASTHMA

```{r}

pal <- colorFactor(
  palette = c("lightblue", "steelblue", "royalblue4", "navy"),  
  levels = c("0-2", "2-4", "4-7", "7+"),
  na.color = "grey")

pal3 <- colorFactor(
  palette = c("red", "green"),
  domain = mn_powerplants$energy_source)


plot <- leaflet(zcta_joined) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~pal(value_cat),
    color = "black",
    weight = 1,
    opacity = 1,
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 2,
      color = "white"),
    label = ~paste0(
      "Zipcode: ", ZCTA5CE20, "\n",
      "Rate: ", ifelse(is.na(`Age-adjusted rate per 10,000`), "Not given due to small population", `Age-adjusted rate per 10,000`))) %>%
  addLegend(
    pal = pal,
    values = ~value_cat,
    opacity = 0.7,
    title = "Asthma related hospitalizations per 10,000 between 2017-2021",
    position = "bottomright",
    na.label = "Not given") %>%
  addCircleMarkers(
    color = ~pal3(energy_source),
    data = mn_powerplants,
    lng = ~Longitude,
    lat = ~Latitude,
    radius = 0.25,
    fillOpacity = 1,
    label = ~paste0("Plant Name: ", Plant_Name, "\n", 
                    "Plant Code:", Plant_Code))

plot


```

ASTHMA & EJ & POWER PLANTS

```{r}
ej_justice <- read_csv("csv_env_ej_mpca_census/ej_mpca_census.csv")
ej_shapefile <- sf::st_read("shp_env_ej_mpca_census/ej_mpca_census.shp")

ej_shapefile_cleaned <- ej_shapefile %>%
  mutate(ej_status = if_else(status200x == "YES" | statuspoc == "YES" | statuslep == "YES", TRUE, FALSE))

zcta_joined <- st_transform(zcta_joined, 4326)
ej_shapefile_cleaned <- st_transform(ej_shapefile_cleaned, 4326)




pal <- colorFactor(
  palette = c("lightblue", "steelblue", "royalblue4", "navy"),  
  levels = c("0-2", "2-4", "4-7", "7+"),
  na.color = "grey")

pal2 <- colorFactor(
  palette = c("green", "red"),
  domain = ej_shapefile_cleaned$ej_status
)


plot2 <- leaflet(zcta_joined) %>%
  addTiles() %>%
  addPolygons(
    fillColor = ~pal(value_cat),
    color = "black",
    weight = 1,
    opacity = 1,
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 2,
      color = "white",
      bringToFront = TRUE),
    label = ~paste0(
      "Zipcode: ", ZCTA5CE20, "\n",
      "Rate: ", ifelse(is.na(`Age-adjusted rate per 10,000`), "Not given due to small population", `Age-adjusted rate per 10,000`)),
    group = "Asthma") %>%
  addPolygons(
    data = ej_shapefile_cleaned,
    color = ~pal2(ej_status),
    fillColor = "transparent",
    weight = 1,
    opacity = 1,
    fillOpacity = 0.7,
    highlight = highlightOptions(
      weight = 2,
      color = "white",
      bringToFront = TRUE),
    label = ~ej_status,
    group = "EJ Tracts"
    ) %>%
  addLegend(
    pal = pal,
    values = ~value_cat,
    opacity = 0.7,
    title = "Asthma related hospitalizations per 10,000 between 2017-2021",
    position = "bottomright",
    na.label = "Not given") %>%
  addCircleMarkers(
    data = mn_powerplants,
    lng = ~Longitude,
    lat = ~Latitude,
    radius = 0.25,
    fillOpacity = 1,
    color = "red",
    group = "Power Plants") %>%
  addLayersControl(
  overlayGroups = c("Asthma", "EJ Tracts", "Power Plants"),
  options = layersControlOptions(collapsed = FALSE)
)
plot2

```

EJ Mile Radius

```{r}
points_sf <- st_as_sf(mn_powerplants,
                      coords = c("Longitude", "Latitude"),
                      crs = 4326) 
ej_areas <- ej_shapefile %>%
  filter(status200x == "YES")

ej_tracts_proj <- st_transform(ej_areas, 26915)
pp_points_proj <- st_transform(points_sf, 26915)


tracts_buffer <- st_buffer(ej_tracts_proj, dist = (1609.34/2))
within_half_mile <- st_within(pp_points_proj, tracts_buffer)
points_sf$within_half_mile <- lengths(within_half_mile) > 0
points_sf$within_half_mile

points_inside <- st_within(pp_points_proj, ej_tracts_proj)
points_sf$inside_tract <- lengths(points_inside) > 0


points_sf %>%
  group_by(energy_source) %>%
  summarise(count_inside_or_near = sum(inside_tract | within_half_mile))


```

SIMPLE PLOTS

```{r}
# Simple plots

mn_counties <- counties(state = "MN", cb = TRUE)
mn_tracts <- tracts(state = "MN", cb = TRUE)
# color palette: (working on it)
pal2 <- colorFactor(c("navy", "red", "green","cyan", "purple", "pink", "black", "red4",
                     "blue"),
                   domain = c("batteries", "biomass", "coal", "natural gas",
                              "nuclear", "other", "petroleum", "solar",
                              "wind"))

pal3 <- colorFactor(c("palegreen", "seashell"),
                    domain = c(TRUE, FALSE))
# Plotting power plants
leaflet() %>%
  # putting layer of counties
  addPolygons(
    data = mn_counties,
    fill = FALSE,
    weight = 1,
    color = "black",
    opacity = 0.7,
    group = "Counties"
  ) %>%
  # putting layer of tracts
  addPolygons(
    data = mn_tracts,
    fill = FALSE,
    weight = 0.5,
    color = "gray",
    opacity = 0.5,
    group = "Tracts"
  ) %>%
  addPolygons(
    data = ej_shapefile_cleaned,
    weight = 1,
    opacity = 1,
    fillOpacity = 0.7,
    fillColor = ~pal3(ej_status),
    highlight = highlightOptions(
      weight = 2,
      color = "white",
      bringToFront = FALSE),
    label = ~ej_status,
    group = "EJ Tracts"
    ) %>%
  # putting circles for each powerplant
  addCircleMarkers(
    data = mn_powerplants,
    lng = ~Longitude,
    lat = ~Latitude,
    radius = 0.25,
     color = ~pal2(PrimSource),
    fillOpacity = 0.25,
    label = ~paste0("Plant Name: ", Plant_Name, "\n",
                   "Company Name: " , Utility_Name)) %>%
  # adding a legend to identify type of powerplant
   addLegend(pal = pal2,
                values = mn_powerplants$PrimSource, title = 'Type of Powerplant')
```

EPA API DATA

```{r}
# Load httr package
library(httr)

# Define the API URL
url <- "https://aqs.epa.gov/data/api/annualData/bySite"

years <- 2000:2020
all_data <- list()

for (yr in years) {
  query_params <- list(
    email  = "sohr@macalester.edu",
    key    = "amberbird59",    
    param  = "88101",       # PM2.5
    bdate  = paste0(yr, "0101"),
    edate  = paste0(yr, "1231"),
    state  = "27",
    county = "123",
    site   = "0868"
  )
  
  27-053-1007

  
  response <- GET(url, query = query_params)
  if (status_code(response) == 200) {
    data_text <- content(response, as = "text", encoding = "UTF-8")
    data_json <- fromJSON(data_text)
    
    if (length(data_json$Data) > 0) {
      all_data[[as.character(yr)]] <- data_json$Data
    } else {
      message("No data for year ", yr)
    }
  } else {
    message("Request failed for year ", yr, " with status: ", status_code(response))
  }
}

# Combine all years into one data frame
final_df <- bind_rows(all_data)

df<-final_df %>%
  filter(metric_used == "Daily Mean") %>%
  arrange(year) %>%
  filter(method == 'R & P Model 2025 PM-2.5 Sequential Air Sampler w/VSCC - Gravimetric'| method == 'Andersen RAAS2.5-300 PM2.5 SEQ w/WINS - GRAVIMETRIC') %>%
  distinct(arithmetic_mean, .keep_all = TRUE) %>%
  mutate(year = as.numeric(year))

aq_copd <- df %>% left_join(copd_total_hospitalizations)

aq_plot <- df %>% ggplot(aes(x = year, y = arithmetic_mean)) +
  geom_line()

copd_plot <- aq_copd %>% ggplot(aes(x = year, y = hospitalizations)) +
  geom_line()

ggarrange(aq_plot, copd_plot, 1,1)
  

```

EPA API DATA PM10

```{r}
url <- "https://aqs.epa.gov/data/api/annualData/bySite"

years <- 1999:2025
all_data1 <- list()

for (yr in years) {
  query_params <- list(
    email  = "sohr@macalester.edu",
    key    = "taupemallard55",    
    param  = "88101",       # PM10
    bdate  = paste0(yr, "0101"),
    edate  = paste0(yr, "1231"),
    state  = "27",
    county = "123",
    site   = "0868"
  )

  

  
  response <- GET(url, query = query_params)
  if (status_code(response) == 200) {
    data_text <- content(response, as = "text", encoding = "UTF-8")
    data_json <- fromJSON(data_text)
    
    if (length(data_json$Data) > 0) {
      all_data1[[as.character(yr)]] <- data_json$Data
    } else {
      message("No data for year ", yr)
    }
  } else {
    message("Request failed for year ", yr, " with status: ", status_code(response))
  }
}

# Combine all years into one data frame
final_df_PM2.5 <- bind_rows(all_data1)
final_df_PM2.5
```
