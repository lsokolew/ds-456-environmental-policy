---
title: "capstone_project_work"
format: html
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(leaflet)
library(tigris)
library(dplyr)
library(readr)
library(lubridate)
```

# Load in & Wrangle Data

Dataset: 

```{r warning=FALSE, message=FALSE}
# read in powerplant location & characteristic data
powerPlants <- read_csv("Data/Power_Plants.csv")
mn_powerplants <- powerPlants %>%
  filter(State == "Minnesota") %>% 
  mutate(fossil_fuel = ifelse(PrimSource %in% c("coal", "petroleum", "natural gas"), "Fossil Fuel", "Renewable"),
         PrimSource = ifelse(PrimSource == "other", "waste heat", PrimSource))  %>% # change 'other' to 'waste heat'
  janitor::clean_names() 
```

Dataset: 
air quality only goes 2008-2021

```{r warning=FALSE, message=FALSE,results='hide'}
# read in air quality data
mn_aq_all_years <- read_csv("Data/Modeled_PM25_Ozone_MN_county_data_allyears.csv") %>% 
  mutate(county = str_split_i(county, ",", 1),
         county = str_remove(county, "County"),
         county = str_trim(county)
         )
```

Dataset: Form EIA-860

```{r}
# load in dataset containing powerplant first operational date
powerplant_dates <- read_csv("Data/powerplant_data_eia_egrid_2024_generator_operable.csv") %>% 
  janitor::clean_names() 

# filter to MN and get date of *first* operational generator for a powerplant (disregard dates of generators added later)
powerplant_dates_mn <- powerplant_dates %>% 
  filter(state == "MN") %>% 
  mutate(full_date = make_date(year = operating_year, month = operating_month, day = 1)) %>% 
  group_by(plant_code) %>% 
  summarise(first_op_date = min(full_date))

# add years to mn_powerplants
mn_powerplants <- mn_powerplants %>% left_join(powerplant_dates_mn)

# fill in missing dates:
# Buffalo Sun CSG - active since 2/1/2025
# Oster Sun CSG	- active since 1/1/2025
# Quarry Sun CSG - active since 1/1/2025
# via sunshare website
mn_powerplants <- mn_powerplants %>%
  mutate(first_op_date = case_when(plant_code == 66070 ~ as.Date(mdy("2/1/2025")),
                                   plant_code == 66072 ~ as.Date(mdy("1/1/2025")),
                                   plant_code == 66073 ~ as.Date(mdy("1/1/2025")),
                                   TRUE ~ first_op_date), 
         first_op_year = year(first_op_date)
         ) 
```


```{r}
# read in dataset containing powerplant retirement date, if applicable
powerplant_dates_retired_mn <- read_csv("Data/powerplant_data_eia_egrid_2024_generator_retired.csv") %>% 
  janitor::clean_names() %>% 
  filter(state == "MN")

# get date of *last* generator's retirement for a powerplant (disregard dates of generators retired later)
powerplant_dates_retired_mn <- powerplant_dates_retired_mn %>% 
  mutate(full_retirement_date = make_date(year = retirement_year, month = retirement_month, day = 1)) %>% 
  group_by(plant_code) %>% 
  summarise(last_retire_date = max(full_retirement_date, na.rm = TRUE)) # those with missing dates don't appear in mn_powerplants & can be excluded

# join to mn_powerplants
mn_powerplants <- mn_powerplants %>% left_join(powerplant_dates_retired_mn) %>% mutate(last_retire_year = year(last_retire_date))
```

```{r warning=FALSE, message=FALSE,results='hide'}
# load spatial/boundary info
mn_counties <- counties(state = "MN", cb = TRUE) %>%
  st_transform(crs = 4326)

mn_tracts <- tracts(state = "MN", cb = TRUE) %>%
  st_transform(crs = 4326)
```

```{r}
# join AQ data to add spatial data
mn_counties_aq <- mn_counties %>%
  left_join(mn_aq_all_years, by = c("NAME" = "county")) %>% 
  janitor::clean_names()
```


# Visualizations

```{r}
pal_pp <- colorFactor(
  c("black",
    "darkgreen"),
  domain = mn_powerplants$fossil_fuel
)

# Plotting all power plants that have existed in MN
leaflet() %>%
  # putting layer of counties
  addPolygons(
    data = mn_counties,
    fillColor = "lightgray",
    weight = 1,
    color = "darkgray",
    fillOpacity = .6,
    group = "Counties"
  ) %>%
  # putting layer of tracts
  addPolygons(
    data = mn_tracts,
    fillColor = FALSE,
    weight = 0.5,
    color = "gray",
    opacity = 0.5,
    group = "Tracts"
  ) %>%
  # putting circles for each power plant
  addCircleMarkers(
    data = mn_powerplants,
    lng = ~ longitude,
    lat = ~ latitude,
    radius = 0.25,
    color = ~pal_pp(fossil_fuel),
    opacity = 0.35
  ) %>% 
  addLegend(
  pal = pal_pp,
  values = mn_powerplants$fossil_fuel,
  title = "Power Plants: Energy Type"
  ) 
```

This map shows the locations of all powerplants that have been built in Minnesota since 1900, with black points being fossil-fuel powered and green points being renewable-powered. The power plants seem clustered in the southern half of the state, particularly renewable plants, which seem to outnumber fossil-fuel plants. 

```{r}
map_mn_aq <- function(year_spec, pollutant_spec){
  
  # filter df based on user specs
  filtered_mn_aq <- mn_counties_aq %>% filter(year <= year_spec, pollutant == pollutant_spec)
  filtered_mn_powerplants <- mn_powerplants %>% filter(first_op_year <= year_spec, is.na(last_retire_year) | last_retire_year > year_spec)
  
    pal_pp <- colorFactor(
    c("black",
      "darkgreen"),
    domain = filtered_mn_powerplants$fossil_fuel
  )
  
  pal_aqi <- colorNumeric("YlOrRd", domain = filtered_mn_aq$average_concentration)

  # Plotting power plants
  leaflet() %>%
    # putting layer of counties
    addPolygons(
      data = filtered_mn_aq,
      fillColor = ~ pal_aqi(average_concentration),
      weight = 1,
      color = "black",
      fillOpacity = .6,
      group = "Counties"
    ) %>%
    # putting layer of tracts
    addPolygons(
      data = mn_tracts,
      fillColor = FALSE,
      weight = 0.5,
      color = "gray",
      opacity = 0.5,
      group = "Tracts"
    ) %>%
    # putting circles for each power plant
    addCircleMarkers(
      data = filtered_mn_powerplants,
      lng = ~ longitude,
      lat = ~ latitude,
      radius = 0.25,
      color = ~pal_pp(fossil_fuel),
      opacity = 0.35
    ) %>% 
    addLegend(
    pal = pal_pp,
    values = filtered_mn_powerplants$fossil_fuel,
    title = "Power Plants: Energy Type"
    )  %>% 
    addLegend(
    pal = pal_aqi,
    values = filtered_mn_aq$average_concentration,
    title = "Pollutant Avg" # (µg/m3)
    ) 
  
}
```

```{r}
map_mn_aq(2008, "Ozone")
map_mn_aq(2015, "Ozone")
map_mn_aq(2021, "Ozone")


map_mn_aq(2008, "PM2.5")
map_mn_aq(2010, "PM2.5")
map_mn_aq(2015, "PM2.5")
map_mn_aq(2018, "PM2.5")
map_mn_aq(2021, "PM2.5")
```

This plot allows for a user-specified year and pollutant, to the end of becoming an interactive plot with a slider for year. We can see a lot more renewable plants getting built in later years, but air quality doesn't seem to follow clear patterns over time. Connections between air quality and presence of power plants are not immediately apparent.

```{r}
mn_powerplants %>% 
  ggplot(aes(x = first_op_year, fill = fossil_fuel)) +
  geom_bar() +
  facet_wrap(~fossil_fuel) +
  labs(title = "When have different kinds of powerplants been built in Minnesota?") +
  theme_classic() 

# interesting that earliest powerplants are renewable - they're all hydroelectric power
mn_powerplants %>% filter(first_op_year < 1920)

# TO DO: make plot of de-op pps - when do they get decomissioned?
```

The plots show the shift to renewable power around the turn of the century, preceding a huge boom in their construction around 2018. We can see that fossil fuel plant construction has remained fairly constant post-1950, with a lull in the 80s and a spike in the early 2000s. However, the numbers of new fossil fuel plants become nearly insignificantcompared to the overwhelming amounts of new renewable plants.

The earliest plants were also renewable ones, making use of exclusively hydroelectric power as shown in the table. 

```{r}
mn_powerplants %>% 
  ggplot(aes(x = fct_infreq(prim_source))) +
  geom_bar() +
  labs(x = "Energy Source", y = "Number of Powerplants", title = "Minnesota Powerplants' Energy Sources") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

mn_powerplants %>% 
  group_by(prim_source) %>% 
  summarise(prod_by_type = sum(total_mw)) %>% 
  mutate(fossil_fuel = ifelse(prim_source %in% c("coal", "petroleum", "natural gas"), "Fossil Fuel", "Renewable")) %>% 
  ggplot(aes(x = fct_reorder(prim_source, prod_by_type, .desc = TRUE), y = prod_by_type, fill = fossil_fuel)) +
  geom_bar(stat = 'identity') +
  labs(x = "Energy Source", y = "MW produced", title = "Energy produced by Source in MN Powerplants") +  
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# TO DOs:
# change color scheme
# consider time frame - specific year? this is just showing all that have ever existed
```

Across all plants built in MN, we can see that by far the most (by nearly five times) solar-fueled plants have been built, by numbers alone. There seem to be very few coal plants, although petroleum and natural gas have a notable amount. However, looking at the actual energy produced by each fuel type, natural gas produces the most, followed by wind and coal, suggesting that fossil-fuel plants are either larger and/or more efficient - a single fossil-fuel plant can produce more energy than a renewable one. Solar power produces only about 1800 MWs, less than a third of natural gas's production, despite having over 10x the number of plants. 

```{r}
# which counties to look at? ones with new fossil fuel plants in our time range
mn_powerplants %>% filter(fossil_fuel == "Fossil Fuel", first_op_year > 2007) %>% count(county) %>% arrange(desc(n)) %>% head()
```

This table shows which counties have the most new fossil fuel plants built within the time frame of our air quality data (2008-2021), for the sake of analysis.

```{r}
# line chart of county or groups of counties - showing air quality over time; vertical lines when plants were built
#county_spec <- "Dakota"
county_spec <- "Olmsted"

pollutant_spec <- "Ozone"
#pollutant_spec <- "PM2.5"

mn_powerplants_filtered <- mn_powerplants %>% 
  filter(county == county_spec, first_op_year >= 2008, first_op_year <= 2021) %>% 
  mutate(first_op_date_jittered = first_op_date + ifelse(fossil_fuel == "Fossil Fuel", 7, -7)) # jitter so lines don't cover each other

ggplot() +
  geom_line(data = mn_counties_aqi %>% filter(name == county_spec, pollutant == pollutant_spec) %>% 
    mutate(year = as.Date(paste0(year, "-01-01"))), aes(x = year, y = average_concentration)) +
  geom_vline(data = mn_powerplants_filtered, aes(xintercept = first_op_date_jittered, color = fossil_fuel)) + 
  scale_color_manual(
    name = "Plant Fuel Type",
    values = c("Renewable" = "aquamarine3", "Fossil Fuel" = "#EE6A50")
  ) +
  labs(title = str_c("Average ", pollutant_spec, " Concentration & Power Plants Built in ", county_spec, " County"), 
       y = str_c("Average ", pollutant_spec, " Concentration"),
       x = "Year") +
  theme_classic()
# TO DO : make capable of handling clusters of counties
```

This plot is also designed to be interactive. In this case, there appears little connection between air quality and fossil fuel plants being built. 

```{r}
#Overall trends in AQ

mn_counties_aqi %>% 
  filter(pollutant == "Ozone") %>% 
  ggplot() +
    geom_line(aes(x = year, y = average_concentration, group = name, color = name), show.legend = FALSE) +
  labs(title = "Average Ozone Concentration By County") +
  ylim(0,40) +
  theme_classic()

mn_counties_aqi %>% 
  filter(pollutant == "Ozone") %>% 
  group_by(year) %>% 
  summarise(avg_conc_by_year = mean(average_concentration)) %>% 
  ggplot() +
    geom_line(aes(x = year, y = avg_conc_by_year)) +
  labs(title = "Ozone Concentration (Average of All MN Counties)") +
  ylim(0,38) +
  theme_classic()
```

Average ozone concentration does not seems to change too drastically in this time frame; although it dips somewhat around 2016 before rising again. All counties seems to follow the overall trend, with a more distinctive high around 2013 and low around 2015-2016. 

```{r}
mn_counties_aqi %>% 
  filter(pollutant == "PM2.5") %>% 
  ggplot() +
    geom_line(aes(x = year, y = average_concentration, group = name, color = name), show.legend = FALSE) +
  labs(title = "Average PM2.5 Concentration By County") +
  ylim(0, 12) +
  theme_classic()

mn_counties_aqi %>% 
  filter(pollutant == "PM2.5") %>% 
  group_by(year) %>% 
  summarise(avg_conc_by_year = mean(average_concentration)) %>% 
  ggplot() +
    geom_line(aes(x = year, y = avg_conc_by_year)) +
  labs(title = "PM2.5 Concentration (Average of All MN Counties)") +
  ylim(0, 10) +
  theme_classic()

# What's causing the 2021 spike?
```
There seems to be more variation in PM2.5, and a distinct pattern shared across counties that suggests larger-scale factors (such as large wildfires) affect each county's air quality more than individual elements like the addition of powerplants. The is a zig-zag pattern between 2014 and 2020, in which PM2.5 jumps and then drops every few years. 2021 measurements seems to be rising back to, or even exceeding pre-2014 levels. 


```{r}
# combine the two
#pollutant_spec <- "Ozone"
pollutant_spec <- "PM2.5"

summary_df <- mn_counties_aqi %>%
  filter(pollutant == pollutant_spec) %>% 
  group_by(name) %>%
  summarize(mean_aqi = mean(average_concentration, na.rm = TRUE)) %>%
  left_join(
    mn_powerplants %>%
      group_by(county) %>% 
      count(fossil_fuel) %>% 
      filter(fossil_fuel == "Fossil Fuel"),
    by = c("name" = "county")
  ) %>% 
  mutate(num_fossil = ifelse(is.na(n), 0, n))

ggplot(summary_df, aes(x = num_fossil, y = mean_aqi)) +
  geom_point(color = "red") +
  geom_smooth(method = 'lm',color = "black") +
  labs(title = str_c("MN Counties' Average Air Quality vs Number of Fossil Fuel Plants"),
       x = "Number of Fossil Fuel Plants",
       y = str_c("Mean ", pollutant_spec, " Concentration")) +
  theme_classic()


# renewables 
summary_df <- mn_counties_aqi %>%
  filter(pollutant == pollutant_spec) %>% 
  group_by(name) %>%
  summarize(mean_aqi = mean(average_concentration, na.rm = TRUE)) %>%
  left_join(
    mn_powerplants %>%
      group_by(county) %>% 
      count(fossil_fuel) %>% 
      filter(fossil_fuel == "Renewable"),
    by = c("name" = "county")
  ) %>% 
  mutate(num_fossil = ifelse(is.na(n), 0, n))

ggplot(summary_df, aes(x = num_fossil, y = mean_aqi)) +
  geom_point(color = "turquoise") +
  geom_smooth(color = "black") +
  labs(title = str_c("MN Counties' Average Air Quality vs Number of Renewable Plants"),
       x = "Number of Renewable Plants",
       y = str_c("Mean ", pollutant_spec, " Concentration")) +
  theme_classic()

```
A county having more fossil fuel plants appears to be associated with higher PM2.5 concentrations on average. However, having fewer renewable power plants seems associated with better air quality also, which calls this analysis into question, as renewable plants should not be affecting the air quality. 


```{r}
summary_df <- mn_counties_aqi %>%
  filter(pollutant == pollutant_spec) %>% 
  group_by(name) %>%
  summarize(mean_aqi = mean(average_concentration, na.rm = TRUE)) %>%
  left_join(
    mn_powerplants %>%
      group_by(county) %>% 
      summarize(has_fossil = any(fossil_fuel == "Fossil Fuel")),
    by = c("name" = "county")
  ) %>%
  mutate(has_fossil = ifelse(is.na(has_fossil), FALSE, has_fossil),
         plant_group = ifelse(has_fossil, "Contains Fossil Fuel Plants", "No Fossil Fuel Plants"))

ggplot(summary_df, aes(x = plant_group, y = mean_aqi, fill = plant_group)) +
  geom_boxplot(alpha = 0.7, outlier.color = "gray40") +
  geom_jitter(width = 0.15, alpha = 0.6) +
  labs(
    title = str_c("Mean ", pollutant_spec, " Concentration by County Type"),
    x = NULL,
    y = str_c("Mean ", pollutant_spec, " Concentration")
  ) +
  ylim(0,10) +
  scale_fill_manual(values = c("Contains Fossil Fuel Plants" = "#d95f02",
                               "No Fossil Fuel Plants" = "#1b9e77")) +
  theme_classic() +
  theme(legend.position = "none")

mn_powerplants %>% group_by(county) %>% count(fossil_fuel)
```
This plot suggests that counties containing fossil fuel plants have higher concentrations of pm2.5 than those containing only renewable or no powerplants. 

# Future Steps

```{r}
# Heatmaps: correlation between number of fossil/renewable plants and pollution per county.
# 
# Line plots: before-and-after trends in air quality for counties that transitioned to renewables.
```

- do a timeseries analysis, á la correlated data? Model accounting for time or spatial correlation 
- consider buffer area around plant
- look into install_MW
- look into potential confounders
  - What's causing the 2021 spike in aq?
- look into why powerplants are where they are
- look at select counties with air monitors post-2021, beyond the scope of my current modeled data. look at impacts of wildfires (2023)

# AI Statement

-----
